-- Create database
CREATE DATABASE IF NOT EXISTS ebook_system;
USE ebook_system;

-- Users table
CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    full_name VARCHAR(100) NOT NULL,
    address TEXT,
    phone VARCHAR(20),
    membership_type ENUM('free', 'premium') DEFAULT 'free',
    registration_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    role ENUM('user', 'admin') DEFAULT 'user'
);

-- Categories table
CREATE TABLE IF NOT EXISTS categories (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    icon VARCHAR(50)
);

-- Books table (removed is_free column)
CREATE TABLE IF NOT EXISTS books (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    author VARCHAR(255) NOT NULL,
    description TEXT,
    preview_content TEXT,
    price DECIMAL(10,2) NOT NULL DEFAULT 0.00,
    category_id INT,
    file_path VARCHAR(255),
    cover_image VARCHAR(255),
    subscription_required BOOLEAN DEFAULT FALSE,
    subscription_years INT DEFAULT 1,
    featured BOOLEAN DEFAULT FALSE,
    status ENUM('active', 'inactive') DEFAULT 'active',
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    stock_quantity INT DEFAULT 0,
    pages INT,
    publication_year YEAR,
    isbn VARCHAR(20)
);

-- Orders table
CREATE TABLE IF NOT EXISTS orders (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    order_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10,2) NOT NULL,
    shipping_charges DECIMAL(10,2) DEFAULT 0,
    format ENUM('pdf', 'hardcopy', 'cd') NOT NULL,
    status ENUM('pending', 'confirmed', 'shipped', 'delivered', 'cancelled') DEFAULT 'pending',
    payment_status ENUM('pending', 'paid', 'failed') DEFAULT 'pending',
    shipping_address TEXT
);

-- Order items table
CREATE TABLE IF NOT EXISTS order_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    book_id INT NOT NULL,
    quantity INT DEFAULT 1,
    price DECIMAL(10,2) NOT NULL
);

-- Competitions table
CREATE TABLE IF NOT EXISTS competitions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    type ENUM('essay', 'story') NOT NULL,
    start_date DATETIME NOT NULL,
    end_date DATETIME NOT NULL,
    rules TEXT,
    prizes TEXT,
    status ENUM('upcoming', 'active', 'completed') DEFAULT 'upcoming',
    max_submissions INT DEFAULT 100,
    entry_fee DECIMAL(10,2) DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);

-- Competition submissions table
CREATE TABLE IF NOT EXISTS competition_submissions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    competition_id INT NOT NULL,
    user_id INT NOT NULL,
    title VARCHAR(255) NOT NULL,
    content TEXT NOT NULL,
    file_path VARCHAR(255),
    submission_time DATETIME DEFAULT CURRENT_TIMESTAMP,
    is_winner BOOLEAN DEFAULT FALSE,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    participant_name VARCHAR(255),
    participant_email VARCHAR(255),
    FOREIGN KEY (competition_id) REFERENCES competitions(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Winners table
CREATE TABLE IF NOT EXISTS winners (
    id INT AUTO_INCREMENT PRIMARY KEY,
    competition_id INT NOT NULL,
    user_id INT NOT NULL,
    submission_id INT NOT NULL,
    prize_details TEXT,
    prize_amount DECIMAL(10,2),
    position INT,
    announced_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (competition_id) REFERENCES competitions(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (submission_id) REFERENCES competition_submissions(id)
);

-- Dealers table
CREATE TABLE IF NOT EXISTS dealers (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address TEXT NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(100),
    city VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE
);

-- Book reviews table
CREATE TABLE IF NOT EXISTS book_reviews (
    id INT AUTO_INCREMENT PRIMARY KEY,
    book_id INT NOT NULL,
    user_id INT NOT NULL,
    rating INT NOT NULL CHECK (rating >= 1 AND rating <= 5),
    review_text TEXT,
    review_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'approved', 'rejected') DEFAULT 'pending',
    FOREIGN KEY (book_id) REFERENCES books(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- Payments table
CREATE TABLE IF NOT EXISTS payments (
    id INT AUTO_INCREMENT PRIMARY KEY,
    order_id INT NOT NULL,
    payment_method ENUM('credit_card', 'debit_card', 'paypal', 'bank_transfer') NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    transaction_id VARCHAR(255),
    payment_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    status ENUM('pending', 'completed', 'failed', 'refunded') DEFAULT 'pending',
    FOREIGN KEY (order_id) REFERENCES orders(id)
);

-- Subscriptions table
CREATE TABLE IF NOT EXISTS subscriptions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    book_id INT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status ENUM('active', 'expired', 'cancelled') DEFAULT 'active',
    created_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (book_id) REFERENCES books(id)
);

-- Insert sample data
INSERT INTO categories (name, description, icon) VALUES
('Fiction', 'Novels and fictional stories', 'fas fa-book-open'),
('Science', 'Scientific books and research', 'fas fa-flask'),
('History', 'Historical accounts and analysis', 'fas fa-history'),
('Romance', 'Romantic novels and stories', 'fas fa-heart'),
('Mystery', 'Mystery and detective stories', 'fas fa-user-secret'),
('Sci-Fi', 'Science fiction and fantasy', 'fas fa-rocket');

-- Updated book data with preview_content
INSERT INTO books (title, author, description, preview_content, price, category_id, cover_image, featured) VALUES
('Pride and Prejudice', 'Jane Austen', 'A romantic novel of manners', 'It is a truth universally acknowledged, that a single man in possession of a good fortune, must be in want of a wife. However little known the feelings or views of such a man may be on his first entering a neighbourhood, this truth is so well fixed in the minds of the surrounding families, that he is considered the rightful property of some one or other of their daughters.', 4.99, 1, 'https://bookabook.pk/cdn/shop/products/pride_fe99a8a8-9bed-47d8-a66a-89c9e60d800f.png?v=1626023310&width=600', 1),
('A Brief History of Time', 'Stephen Hawking', 'Exploring the nature of time and universe', 'We shall not cease from exploration, and the end of all our exploring will be to arrive where we started and know the place for the first time. Through the unknown, remembered gate when the last of earth left to discover is that which was the beginning; at the source of the longest river the voice of the hidden waterfall.', 8.99, 2, 'https://bookabook.pk/cdn/shop/products/58310deb61dc2eefe535be2aec219cb6_bc5e7bf0-9cf7-4abc-84cd-3a12553d8841.jpg?v=1651096938&width=600', 1),
('The Art of War', 'Sun Tzu', 'Ancient Chinese military treatise', 'The art of war is of vital importance to the State. It is a matter of life and death, a road either to safety or to ruin. Hence it is a subject of inquiry which can on no account be neglected. The art of war, then, is governed by five constant factors, to be taken into account in ones deliberations.', 5.99, 3, 'https://onlinebooksoutlet.com/cdn/shop/products/the-art-of-war-buy-online.jpg?v=1749047016&width=713', 1),
('Romeo and Juliet', 'William Shakespeare', 'Tragic love story', 'Two households, both alike in dignity, In fair Verona, where we lay our scene, From ancient grudge break to new mutiny, Where civil blood makes civil hands unclean. From forth the fatal loins of these two foes A pair of star-cross''d lovers take their life; Whose misadventured piteous overthrows Do with their death bury their parents'' strife.', 0.00, 4, 'https://bookabook.pk/cdn/shop/products/0a6c54b7643d1c900399daa3c6368364_29161600-958c-4943-bd70-a2bdbee128f8.jpg?v=1626025701&width=600', 0),
('Sherlock Holmes', 'Arthur Conan Doyle', 'Detective stories collection', 'To Sherlock Holmes she is always the woman. I have seldom heard him mention her under any other name. In his eyes she eclipses and predominates the whole of her sex. It was not that he felt any emotion akin to love for Irene Adler. All emotions, and that one particularly, were abhorrent to his cold, precise but admirably balanced mind.', 6.99, 5, 'https://onlinebooksoutlet.com/cdn/shop/products/Untitled-design-2019-03-14T033914.811.jpg?v=1748526326&width=713', 1),
('1984', 'George Orwell', 'Dystopian social science fiction', 'It was a bright cold day in April, and the clocks were striking thirteen. Winston Smith, his chin nuzzled into his breast in an effort to escape the vile wind, slipped quickly through the glass doors of Victory Mansions, though not quickly enough to prevent a swirl of gritty dust from entering along with him.', 6.49, 6, 'https://www.linkshop.pk/image/cache/books/1984-550x550h.jpg.webp', 1);

INSERT INTO competitions (title, description, type, start_date, end_date, rules, prizes, status) VALUES
('Summer Story Writing', 'Write an engaging short story for summer reading', 'story', '2024-06-01', '2024-08-31', 'Word limit: 2000-5000 words. Original content only.', 'First prize: $500 + Publication', 'active'),
('Essay Competition 2024', 'Annual essay writing competition on technology impact', 'essay', '2024-09-01', '2024-10-31', 'Word limit: 1000-2000 words. Proper citations required.', 'Winners get book bundles and certificates', 'upcoming');

INSERT INTO dealers (name, address, phone, email, city, is_active) VALUES
('City Book Store', '123 Main Street, Downtown', '(555) 123-4567', 'citybooks@example.com', 'New York', 1),
('Readers Paradise', '456 Oak Avenue, Westside', '(555) 987-6543', 'readers@example.com', 'Los Angeles', 1),
('Knowledge Hub', '789 Pine Road, East End', '(555) 456-7890', 'knowledge@example.com', 'Chicago', 1);

-- Create admin user
INSERT INTO users (username, email, password, full_name, role) VALUES 
('admin', 'admin@ebookemporium.com', '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', 'System Administrator', 'admin');
